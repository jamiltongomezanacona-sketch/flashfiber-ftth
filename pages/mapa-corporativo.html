<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Flash Fiber FTTH | GIS Corporativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Iconos app (favicon + PWA) -->
  <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/assets/icons/icon-512.png">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">

  <!-- ICONOS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- MAPBOX -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />

  <!-- CSS (rutas absolutas para rewrite /mapa-ftth) -->
  <link rel="stylesheet" href="/assets/css/theme.css">
  <link rel="stylesheet" href="/assets/css/mobile.css">
  <link rel="stylesheet" href="/assets/css/layout.css">
  <link rel="stylesheet" href="/assets/css/map.css">
  <link rel="stylesheet" href="/assets/css/panels.css">
  <link rel="stylesheet" href="/assets/css/search.css">
</head>

<body class="app-map app-map-corporativo" data-gis="corporativo">
  <script>window.__GEOJSON_INDEX__ = "../geojson/index-corporativo.json";</script>

  <header class="header">
    <button type="button" id="btnSidebar" class="btn-header-icon" aria-label="Abrir menÃº">
      <i class="fas fa-bars" aria-hidden="true"></i>
    </button>
    <a href="home.html" class="btn-home" aria-label="Volver a Home">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>

    <!-- ğŸ” BUSCADOR MODERNO -->
    <div class="search-container">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          id="searchInput" 
          class="search-input" 
          placeholder="Buscar sedes, enlaces, clientes corporativos..."
          autocomplete="off"
        />
        <button id="searchClear" type="button" class="search-clear hidden" aria-label="Limpiar bÃºsqueda">
          <i class="fas fa-times" aria-hidden="true"></i>
        </button>
      </div>
      <div id="searchResults" class="search-results hidden"></div>
    </div>
  </header>

  <!-- ğŸ“‚ SIDEBAR OVERLAY -->
  <div class="sidebar-overlay"></div>
  <aside id="sidebar" class="sidebar hidden">

    <div class="sidebar-header">
      <h2>FLASH FIBER</h2>
      <span>GIS Corporativo</span>
    </div>

    <nav class="sidebar-menu">

      <section class="menu-section">
        <div class="menu-title">HERRAMIENTAS</div>
        <button class="menu-item" data-action="gps">ğŸ“ GPS</button>
        <button class="menu-item" data-action="medir">ğŸ“ Medir</button>
        <button class="menu-item" data-action="navegar">ğŸš— Navegar</button>
      </section>

      <section class="menu-section">
        <div class="menu-title">OPERACION</div>
        <button class="menu-item" data-action="eventos">ğŸ“ Reportar Evento Corp</button>
        <button class="menu-item" data-action="posteria">ğŸ—ï¸ Montar posteria</button>
        <button class="menu-item" data-action="ruta">ğŸ›£ï¸ Montar Ruta</button>
      </section>

      <section class="menu-section">
        <div class="menu-title">DISEÃ‘O</div>
        <button class="menu-item" id="btnDisenoMapa" type="button">ğŸ–¼ï¸ Crear diseÃ±o de mapa</button>
      </section>

      <section class="menu-section">
        <div class="menu-title">RED CORPORATIVA</div>
        <button class="menu-item" id="btnOpenLayers">ğŸ—ºï¸ Capas</button>
      </section>

    </nav>
  </aside>

  <!-- ğŸ—ºï¸ MAPA -->
<main class="map-wrapper">
  <div id="map"></div>

  <div class="map-controls">
    <button id="btnGPS" type="button" aria-label="Centrar en mi ubicaciÃ³n"><i class="fas fa-location-crosshairs" aria-hidden="true"></i></button>
    <button id="btnMedir" type="button" aria-label="Medir distancia"><i class="fas fa-ruler" aria-hidden="true"></i></button>

    <button id="btnRotate" type="button" title="Rotar mapa" aria-label="Rotar mapa"><i class="fas fa-sync-alt" aria-hidden="true"></i></button>
    <button id="btnRotateLeft" type="button" class="map-control-pc" title="Girar mapa a la izquierda" aria-label="Girar mapa a la izquierda"><i class="fas fa-rotate-left" aria-hidden="true"></i></button>
    <button id="btnRotateRight" type="button" class="map-control-pc" title="Girar mapa a la derecha" aria-label="Girar mapa a la derecha"><i class="fas fa-rotate-right" aria-hidden="true"></i></button>
    <button id="btnLimpiarMapa" type="button" title="Limpiar mapa" aria-label="Limpiar mapa"><i class="fas fa-broom" aria-hidden="true"></i></button>
  </div>
</main>


  <!-- ğŸ—‚ï¸ PANEL CAPAS -->
  <div id="layersPanel" class="panel panel-capas hidden">

    <div class="panel-header">
      <span class="panel-title">ğŸ—ºï¸ Capas Corporativas</span>
      <button id="btnCloseLayers">âœ–</button>
    </div>

    <div class="panel-content">
      <div class="capas-corporativo-options">
        <label class="capas-option-ver-todos">
          <input type="checkbox" id="verTodosCablesCheckbox" />
          <span>Ver todos los cables</span>
        </label>
      </div>
      <div id="layersTree" class="panel-content-tree"></div>
    </div>

  </div>

  <!-- ğŸ–¼ï¸ PANEL CREAR DISEÃ‘O DE MAPA (exportar con mÃ¡rgenes y notas) -->
  <div id="disenoMapaPanel" class="panel panel-capas hidden">
    <div class="panel-header">
      <span class="panel-title">ğŸ–¼ï¸ Crear diseÃ±o de mapa</span>
      <button id="btnCloseDisenoMapa" type="button" aria-label="Cerrar">âœ–</button>
    </div>
    <div class="panel-content panel-diseno-map">
      <p class="panel-diseno-desc">Exporta la vista actual con mÃ¡rgenes, tÃ­tulo y notas (diseÃ±o profesional).</p>
      <label class="panel-diseno-label">TÃ­tulo del mapa</label>
      <input type="text" id="disenoMapaTitulo" class="panel-diseno-input" placeholder="Ej: Sector Santa InÃ©s - Red FTTH" maxlength="120" />
      <label class="panel-diseno-label">Notas / Especificaciones</label>
      <textarea id="disenoMapaNotas" class="panel-diseno-textarea" rows="3" placeholder="Observaciones, escala, referencia..."></textarea>
      <label class="panel-diseno-check-wrap">
        <input type="checkbox" id="disenoMapaIncluirFecha" checked />
        <span>Incluir fecha en el diseÃ±o</span>
      </label>
      <div class="panel-diseno-buttons">
        <button type="button" id="btnDescargarImagenMapa" class="btn-diseno-download">
          <i class="fas fa-image"></i> Descargar imagen (PNG)
        </button>
        <button type="button" id="btnDescargarPdfMapa" class="btn-diseno-download">
          <i class="fas fa-file-pdf"></i> Descargar PDF
        </button>
      </div>
    </div>
  </div>

  <!-- ğŸš— MODAL NAVEGACIÃ“N -->
  <div id="navModal" class="nav-modal hidden">

    <div class="nav-card">
      <h3>ğŸ§­ Â¿CÃ³mo deseas navegar?</h3>

      <div class="nav-options">
        <button id="btnNavWaze" class="nav-btn waze">
          ğŸš— Waze
        </button>

        <button id="btnNavGoogle" class="nav-btn google">
          ğŸŒ Google Maps
        </button>
      </div>

      <button id="btnNavCancel" class="nav-cancel">
        Cancelar
      </button>
    </div>

  </div>

  <!-- ğŸ›£ï¸ MODAL RUTA (Montar Ruta + opciÃ³n Guardar en Firebase) -->
  <div id="routeModal" class="route-modal hidden">
    <div class="route-card">
      <div class="route-header">
        <span>ğŸ›£ï¸ Nueva Ruta</span>
        <button id="closeRouteModal">âœ•</button>
      </div>
      <div class="route-body">
        <label>ğŸ“› Nombre</label>
        <input id="routeName" placeholder="Ej: Troncal BA01 Norte">
        <label>ğŸ§± Tipo</label>
        <select id="routeType">
          <option value="troncal">Troncal</option>
          <option value="distribucion">DistribuciÃ³n</option>
          <option value="acometida">Acometida</option>
          <option value="mantenimiento">Mantenimiento</option>
        </select>
        <label>ğŸ¢ Central</label>
        <input id="routeCentral" placeholder="Ej: BACHUE">
        <label>ğŸ“ Observaciones</label>
        <textarea id="routeNotes" placeholder="Notas tÃ©cnicas..."></textarea>
        <p id="routeDistance">Distancia: 0 m</p>
        <label class="route-option-firebase">
          <input type="checkbox" id="routeSaveFirebase" checked />
          <span>â˜ï¸ Guardar en Firebase</span>
        </label>
      </div>
      <div class="route-actions">
        <button class="route-btn primary" id="btnSaveRoute">ğŸ’¾ Guardar</button>
        <button class="route-btn danger" id="btnCancelRoute">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- ================= MODAL EVENTO (igual que GIS FTTH) ================= -->
  <div id="eventoModal" class="route-modal hidden">

    <div class="modal-content">

      <div class="modal-header">
        <h3>ğŸš¨ Registrar Evento</h3>
        <button id="closeEventoModal">âœ–</button>
      </div>

      <div class="modal-body">

        <label>Tipo</label>
        <select id="eventoTipo">
          <option value="">Seleccione</option>
          <option>VANDALISMO</option>
          <option>CORTE</option>
          <option>OBRAS</option>
          <option>MANTENIMIENTO</option>
        </select>

        <label>AcciÃ³n</label>
        <select id="eventoAccion">
          <option value="">Seleccione</option>
          <option>EMPALME_PROVISIONAL</option>
          <option>AJUSTE DE HILO</option>
          <option>RECONSTRUCCION</option>
          <option>BANDEJA</option>
          <option>CABLE EN DAÃ‘O</option>
        </select>

        <label>Estado</label>
        <select id="eventoEstado">
          <option>CRITICO</option>
          <option>PROVISIONAL</option>
          <option>RESUELTO</option>
        </select>

        <label>CABLES</label>
        <div class="evento-cable-wrap">
          <input type="text" id="eventoCable" placeholder="Buscar cable... (escribe y selecciona)" autocomplete="off" />
          <div id="eventoCableResults" class="evento-cable-results hidden" role="listbox"></div>
        </div>

        <label>TÃ©cnico</label>
        <input id="eventoTecnico" placeholder="Ej. Juan PÃ©rez" aria-label="Nombre del tÃ©cnico">

        <label>ğŸ“· Fotos</label>
        <input type="file" id="fotoInput" accept="image/*" capture="environment" multiple>
        <div id="fotoPreview" class="foto-preview"></div>

        <label>Notas</label>
        <textarea id="eventoNotas" class="evento-notas-box" rows="8" placeholder="Escribe aquÃ­ todas las notas del evento..."></textarea>

      </div>

      <div class="modal-footer">
        <button id="btnSaveEvento" aria-label="Guardar evento">ğŸ’¾ Guardar</button>
        <button id="btnDeleteEvento" aria-label="Eliminar evento">ğŸ—‘ï¸ Eliminar</button>
      </div>

    </div>
  </div>

<!-- LIBS (defer: no bloquean el render, se ejecutan en orden al terminar el parse) -->
<script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js" defer></script>

<!-- CONFIG: en local solo config.local.js; en producciÃ³n solo config.production.js (evita 404) -->
<script>
(function(){
  var base = '../';
  var isLocal = typeof location !== 'undefined' && (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:');
  document.write('<script src="' + base + (isLocal ? 'config.local.js' : 'config.production.js') + '"><\/script>');
})();
</script>
<script>
  window.__FTTH_SECRETS__ = window.__FTTH_SECRETS__ || {};
</script>
<script src="/assets/js/config.js" defer></script>
<script src="/assets/js/utils/devtools-guard.js" defer></script>

<!-- âœ… INITIALIZER (debe cargarse antes de otros mÃ³dulos) -->
<script type="module" src="/assets/js/core/initializer.js"></script>

<!-- FIREBASE CORE -->
<script type="module" src="/assets/js/services/firebase.js"></script>
<script type="module" src="/assets/js/services/firebase.db.js"></script>
<script type="module" src="/assets/js/services/firebase.eventos.js"></script>
<script type="module" src="/assets/js/services/firebase.eventosCorp.js"></script>
<script type="module" src="/assets/js/services/firebase.rutas.js"></script>

<!-- Auth Guard - ProtecciÃ³n de rutas -->
<script type="module" src="/assets/js/core/auth.guard.js"></script>

<!-- APP CORE -->
<script src="/assets/js/app.js" defer></script>
<script src="/assets/js/storage.js" defer></script>
<script src="/assets/js/ui/ui.menu.js" defer></script>

<!-- MAPA -->
<script src="/assets/js/map/mapa.init.js" defer></script>
<script src="/assets/js/map/mapa.controls.js" defer></script>
<script src="/assets/js/map/mapa.layers.js" defer></script>

<!-- TOOLS (GPS, Medir, Navegar, Capas, Reportar Evento) -->
<script src="/assets/js/tools/tool.medicion.js" defer></script>
<script src="/assets/js/tools/tool.gps.js" defer></script>
<script src="/assets/js/tools/tool.navegacion.js?v=2026" defer></script>
<script src="/assets/js/tools/tool.capas.js" defer></script>
<script src="/assets/js/tools/tool.eventos.js" defer></script>
<!-- jsPDF se carga bajo demanda al exportar PDF (tool.diseno-mapa.js) -->
<script src="/assets/js/tools/tool.diseno-mapa.js" defer></script>
<script src="/assets/js/tools/tool.rutas.js" defer></script>

<!-- UI -->
<script src="/assets/js/ui/ui.panel.js" defer></script>
<script src="/assets/js/ui/ui.layers.tree.js" defer></script>
<script src="/assets/js/ui/ui.buscador.js" defer></script>



</body>

</html>